---
// Simulateur d'économie d'impôt PER
---

<section id="estimateur" class="section flex flex-col gap-5">
  <h2 class="heading-lg mb-3">Simulez votre économie d'impôt</h2>

  <div class="lg:flex lg:flex-row-reverse lg:gap-8">
    <div class="card flex flex-col gap-5 mb-4 md:p-16 lg:w-2/3 lg:mb-0">

      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="result-card">
          <span class="text-body text-(--color-text-muted)">Économie d'impôt</span>
          <span id="display-economy" class="font-machina text-4xl md:text-5xl text-(--color-primary)">3 000 €</span>
          <span class="text-sm text-(--color-text-muted)">Réduction immédiate</span>
        </div>
        <div class="result-card">
          <span class="text-body text-(--color-text-muted)">Coût réel du versement</span>
          <span id="display-cost" class="font-machina text-4xl md:text-5xl">7 000 €</span>
          <span class="text-sm text-(--color-text-muted)">Après avantage fiscal</span>
        </div>
      </div>

      <div class="visual-bar mt-4">
        <div class="bar-label flex justify-between text-sm mb-2">
          <span>Versement total</span>
          <span id="display-total">10 000 €</span>
        </div>
        <div class="bar-container">
          <div id="bar-economy" class="bar bar-economy" style="width: 30%"></div>
          <div id="bar-cost" class="bar bar-cost" style="width: 70%"></div>
        </div>
        <div class="bar-legend flex justify-between text-xs mt-2 text-(--color-text-muted)">
          <span><span class="legend-dot economy"></span> L'État paie pour vous</span>
          <span><span class="legend-dot cost"></span> Ce que vous payez vraiment</span>
        </div>
      </div>

      <p class="text-sm text-(--color-text-muted) mt-4 pt-6 border-t border-dashed border-(--color-border)">
        Versement sur un Plan d'Épargne Retraite (PER). Sommes bloquées jusqu'à la retraite sauf exceptions (achat résidence principale, etc.).
      </p>
    </div>

    <div class="card-bordered py-8 px-5 flex flex-col gap-8 md:p-16 lg:w-1/3 lg:justify-center">
      <div class="flex flex-col gap-5">
        <label for="tmi" class="font-medium">Votre tranche d'imposition (TMI)</label>
        <select id="tmi" class="input-dashed cursor-pointer">
          <option value="0">0% - Non imposable</option>
          <option value="11">11% - Revenus modestes</option>
          <option value="30" selected>30% - Revenus moyens-hauts</option>
          <option value="41">41% - Hauts revenus</option>
          <option value="45">45% - Très hauts revenus</option>
        </select>
      </div>
      <div class="flex flex-col gap-5">
        <label for="versement" class="font-medium">Montant à verser (€)</label>
        <input type="number" id="versement" value="10000" min="500" max="9999999" step="500" class="input-dashed" />
      </div>
    </div>
  </div>
</section>

<style>
  .result-card {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding: 1.5rem;
    background: var(--color-bg);
    border-radius: 5px;
  }

  .bar-container {
    height: 24px;
    background: var(--color-bg);
    border-radius: 4px;
    overflow: hidden;
    display: flex;
  }

  .bar {
    height: 100%;
    transition: width 0.4s ease;
  }

  .bar-cost {
    background: var(--color-text);
  }

  .bar-economy {
    background: var(--color-primary);
  }

  .legend-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 4px;
  }

  .legend-dot.cost {
    background: var(--color-text);
  }

  .legend-dot.economy {
    background: var(--color-primary);
  }
</style>

<script>
  const tmiSelect = document.getElementById('tmi') as HTMLSelectElement;
  const versementInput = document.getElementById('versement') as HTMLInputElement;
  const displayEconomy = document.getElementById('display-economy');
  const displayCost = document.getElementById('display-cost');
  const displayTotal = document.getElementById('display-total');
  const barCost = document.getElementById('bar-cost');
  const barEconomy = document.getElementById('bar-economy');

  function formatCurrency(value: number): string {
    return new Intl.NumberFormat('fr-FR', {
      style: 'decimal',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(value) + ' €';
  }

  function updateSimulation() {
    const tmi = parseInt(tmiSelect.value) / 100;
    const versement = parseFloat(versementInput.value) || 0;

    const economy = Math.round(versement * tmi);
    const cost = versement - economy;

    if (displayEconomy) displayEconomy.textContent = formatCurrency(economy);
    if (displayCost) displayCost.textContent = formatCurrency(cost);
    if (displayTotal) displayTotal.textContent = formatCurrency(versement);

    // Update bars
    const costPercent = versement > 0 ? (cost / versement) * 100 : 100;
    const economyPercent = versement > 0 ? (economy / versement) * 100 : 0;

    if (barCost) barCost.style.width = `${costPercent}%`;
    if (barEconomy) barEconomy.style.width = `${economyPercent}%`;
  }

  tmiSelect?.addEventListener('change', updateSimulation);
  versementInput?.addEventListener('input', updateSimulation);

  updateSimulation();
</script>
